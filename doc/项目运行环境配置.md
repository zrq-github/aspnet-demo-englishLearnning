# 项目运行环境配置

主要描述本项目启动配置。 会说明从原生项目进行配置的时候所需要的问题。  

## 如何启动程序

- [安装SQLServer](#sqlserver)
- [配置环境变量](#配置系统环境变量)
- [配置Nginx](#配置nginx)

## SQLServer

### 安装SQLServer

微软的SQlServer这么方便安装，应该不用再说什么了吧。  
本地安装就完事其他不用管，都是EFCore完成配置。

## 配置环境变量

### 配置系统环境变量

因为该项目主要是测试学习项目，为了方便，多个微服务统一调用系统的环境变量 “DefaultDB:ConnStr” 。  
多个微服务都从其中获取字符串数据库字符串连接。  

```powershell
# 添加到用户变量
[System.Environment]::SetEnvironmentVariable("DefaultDB:ConnStr", "Server=.;Database=aspnet-demo;Trusted_Connection=True;TrustServerCertificate=True;", "User")
# 添加到系统变量
[System.Environment]::SetEnvironmentVariable("DefaultDB:ConnStr", "Server=.;Database=aspnet-demo;Trusted_Connection=True;TrustServerCertificate=True;", "Machine")
# 两者选一个
```

### 配置数据库中的基础表数据

在数据中增加一个名字为 T_Configs 的表：  

| Id | Name | Value |
| -- | Cors | |
| -- | FileService:SMB |  |
| -- | FileService:UPYun | |
| -- | FileService:Endpoint | |
| -- | Redis | |
| -- | RabbitMQ | |
| -- | ElasticSearch | |
| -- | JWT | |

![](../images/T_Configs表配置示例.png)

Cors: 跨域，前端项目跨域问题；
FileService:SMB：文件服务器保存位置；  
FileService:UPYun：上传云（U盘云？）？没有用到，可以暂时不用配置；  
FileService:Endpoint：文件服务器的路径；  
RabbitMQ：服务器地址；  
ElasticSearch：服务器地址；  
JWT：配置设定

## 配置EFCore

```.NET CLI
# 创建第一个迁移
dotnet ef migrations add InitialCreate
# 创建数据库和架构
dotnet ef database update
```

针对以下项目每个都执行一次：  
- FileService.Infrastructure
- IdentityService.Infrastructure
- Listening.Infrastructure
- MediaEncoder.Infrastructure
- SearchService.Infrastructure

### 执行 FileService.Infrastructure 问题

#### 第1次执行 - FileService

```powshell
dotnet ef migrations add InitialCreate
```
错误：  
FileService.InfrastructureYour startup project 'FileService.Infrastructure' doesn't reference Microsoft.EntityFrameworkCore.Design. This package is required for the Entity Framework Core Tools to work. Ensure your startup project is correct, install the package, and try again.

解决：  
引入 Microsoft.EntityFrameworkCore.Tools Nuget包即可

#### 第2次执行 - FileService  

```powshell
dotnet ef migrations add InitialCreate
```
错误：  
Unable to create an object of type 'FSDbContext'. For the different patterns supported at design time, see https://go.microsoft.com/fwlink/?linkid=851728

解决：  
https://learn.microsoft.com/zh-cn/ef/core/cli/dbcontext-creation?tabs=dotnet-core-cli#from-a-design-time-factory  

问题主要是找不到所连接的数据库。因为代码没有在 DbContext派生类 中配置连接数据库信息。
官网这里说得挺明确的，使用 IDesignTimeDbContextFactory 工具会绕过DbContext的其他方式。

在 FileService.Infrastructure 项目中创建以下代码
```CSharp
public class FSDbContextFactory : IDesignTimeDbContextFactory<FSDbContext>
{
    public FSDbContext CreateDbContext(string[] args) 
    {
        // DbContextOptionsBuilderFactor 需要引用 CommonInitializer 从中所连接的字符串
        var dbOptions = DbContextOptionsBuilderFactory.Create<FSDbContext>();
        return new FSDbContext(dbOptions.Options, null);
    }
}
```

## 配置Nginx

[nginx-down](https://nginx.org/en/download.html)

https://hub.docker.com/_/nginx

### Docker-Nginx

- 执行 git\docker\nginx\Dockerfile [生成新的镜像]((#生成新的nginx镜像))，主要是覆盖 nginx.conf 文件
- 执行 docker run --name nginx-aspnet-demo -d nginx-aspnet-demo 启动镜像

#### 生成新的Nginx镜像

docker build --pull --rm -f "docker\nginx\Dcokerfile" -t nginx-aspnet-demo "docker\nginx"

如果没法执行，可以使用VSCode安装Docker插件，右键Dockerfile文件 -> build image，在这里我给镜像命名为 nginx-aspnet-demo 

### Nginx Docker

- docker search nginx (搜索nginx)
- docker pull nginx:[nginx-version]  (下载指定版本  )
- 

## Elasticsearch